# CLAUDE.md

## Project Overview

mm2ledger imports transactions from MoneyMoney's encrypted SQLite database into ledger-cli journal files. It's a Python CLI tool that replaces a shell-based import pipeline.

## Architecture

### Pipeline: MoneyMoney DB → CSV → ledger convert → journal

1. **password.py** — Resolves the DB password from env vars, 1Password CLI, or (planned) macOS Keychain
2. **database.py** — Shells out to `sqlcipher` to query the encrypted DB, returns JSON-parsed rows
3. **importer.py** — Writes transactions to a temp CSV, runs `ledger convert` for dedup + categorization, appends output to per-account journal files
4. **config.py** — TOML config management with account discovery and merge logic
5. **cli.py** — Click CLI with `config`, `import`, and `list` commands

### Key design decisions

- Uses `sqlcipher` CLI (not a Python binding) — avoids native dependency issues
- Uses `ledger convert` for dedup via UUIDs and payee-based categorization via rules files
- One journal file per account; config maps MoneyMoney account IDs to ledger account names
- Config merges are non-destructive: existing settings preserved, new accounts added as disabled

## Common Commands

```bash
uv sync                              # Install dependencies
uv run mm2ledger --help              # Show CLI help
uv run mm2ledger config --db-path /path/to/MoneyMoney.sqlite  # Discover accounts
uv run mm2ledger import --all        # Import all enabled accounts
uv run mm2ledger import --account "Assets:Checking"  # Import one account
uv run mm2ledger list                # Show configured accounts
```

## Dependencies

- **Runtime**: `click>=8.0`, `tomli-w>=1.0` (plus stdlib `tomllib`)
- **External tools**: `sqlcipher` (encrypted DB access), `ledger` (transaction conversion)
- **Build**: `hatchling`
- **Package manager**: `uv`

## Config File Format

`mm2ledger.toml` — generated by `config` command, stores DB path, password source, ledger directory, and per-account settings (id, name, currency, ledger account, journal file, start date, enabled flag).

## Testing

No tests yet. When adding tests:
- `database.py` and `importer.py` shell out to external tools — mock `subprocess.run` for unit tests
- `config.py` is pure Python — test load/save/merge directly
- For integration tests, use a test SQLite DB (not encrypted) or mock sqlcipher output
